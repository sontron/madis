---
title: "auto generated report by madis"
author: "Powered By madis"
output:
  pdf_document:
    includes:
      in_header: header.tex
    keep_tex: yes
    latex_engine: xelatex
    toc: yes
  html_document: default
  word_document: default
---

# 系统说明

本报告根据选定的变量进行逻辑判断并选择相应的分析方法如t检验，秩和检验，方差分析，相关性分析以及分析模型。

统计软件（语言）为R语言。



```{r}
options(digits=4,knitr.table.format='markdown');library(forecast);library(reshape2);library(plotly);library(knitr);library(zoo);library(xts);library(rpart);library(partykit);library(showtext);library(ggplot2);library(rms);library(Hmisc);library(mgcv);library(stringi);library(fBasics);library(vcdExtra);library(ROCR);library(survival);library(pander);library(ggfortify);library(madis);library(prophet)

opts_chunk$set(echo=F,message=F,warning=F,results='asis',comment=NA,fig.showtext=TRUE,fig.width=7,fig.height=5,knitr.table.format='markdown')

```

```{r}
load('LstMadis.RData')
```

# 描述性结果

描述性分析结果对所选择的变量进行逐一分析，定量变量视其分布是否服从正态分布，以"均值±标准差"或"中位数[25%,75%]"进行呈现，且给出分布的直方图。定性变量则给出频数表，且以条图表达。图形均以R语言ggplot2包绘制。




## 结果部分

```{r}
LstMadis$desc->descParams

if(is.na(descParams$xvars)) {
  cat('\n')
  cat ('当前数据无描述性分析结果')
  cat('\n')
} else {
  for(i in 1:nrow(descParams)){
    cat('\n')
    cat(paste0('### ',descParams$xvars[i],'的结果：'))
    cat('\n')
    #print(pander(resDesc[[i]]$resTabDesc))
    uniVar(data=LstMadis$Data[[descParams$dataName[i]]],xvars=descParams$xvars[i],Digits=descParams$Digits[i])->res
    cat(pander(res$resDesc))
    cat('\n')
    plot(res$graphDesc)
    cat('\n')
  }
}

  


```




# 单因素分析结果

单因素分析对选择的每一个因变量和所有自变量进行逐一分析，分析方法根据变量的类型和分布自动选择，统计方法有：t检验，秩和检验，方差分析，相关性检验，卡方检验等。同时给出图形结果，图形采用R语言ggplot2包进行绘制。

## 结果部分

```{r}
LstMadis$hTest->hTestParams

if(is.na(hTestParams$xvars)){
  cat('\n')
  cat('当前数据无单因素分析结果')
  cat('\n')
} else {
  for(i in 1:nrow(hTestParams)){
    cat('\n')
    cat(paste0('### ',hTestParams$xvars[i],' & ',hTestParams$yvars[i],'的结果：'))
    cat('\n')
    #print(pander(resDesc[[i]]$resTabDesc))
    hTest(data=LstMadis$Data[[hTestParams$dataName[i]]],xvars=hTestParams$xvars[i],yvars=hTestParams$yvars[i],alter=hTestParams$alter[i],paired=hTestParams$paired[i],confLevel=hTestParams$confLevel[i],nullHyp=hTestParams$nullHyp[i])->res
    cat(pander(res$hTestRes))
    cat('\n')
    plot(res$hTestGraph)
    cat('\n')
  }
  
}




```






# 线性模型结果

(广义)线性模型的结果采用R中glm函数进行分析，结果提供全模型以及利用AIC进行变量筛选的逐步回归结果，同时提供模型的诊断图形结果.

## 结果部分

```{r}
LstMadis$myGlm->myGlmParms

if(is.na(myGlmParms$data)){
  cat('\n')
  cat('当前数据无模型分析结果')
  cat('\n')
} else {
  for(i in 1:nrow(myGlmParms)){
    cat('\n')
    cat(paste0('### 第',i,'个模型的结果：'))
    cat('\n')
    
    glmS(Formula=myGlmParms$Formula[i],
          data=LstMadis$Data[[myGlmParms$data[i]]],
          weightsVar=myGlmParms$weightsVar[i],
          subset=myGlmParms$subset[i],
          Family=myGlmParms$Family[i],
          lower=myGlmParms$lower[i])->res
    
    cat('\n')
    cat(paste0('#### 第',i,'个模型的全模型结果：'))
    cat('\n')
    cat(pander(summary(res$glmResFull)))
    cat('\n')
    cat(paste0('#### 第',i,'个模型的全模型诊断图结果：'))
    cat('\n')
    print(autoplot(res$glmResFull))
    cat('\n')
    
    cat('\n')
    if(myGlmParms$Family[i]=='binomial'){
      res$glmResFull->fit.tmp
      predict(fit.tmp,type='link')->pred.fit
      t.scores<-prediction(pred.fit,fit.tmp[['y']])
      cost.perf = performance(t.scores, "cost")
      t.scores@cutoffs[[1]][which.min(cost.perf@y.values[[1]])]->cutoffVal
      perf1<-performance(t.scores,'tpr','fpr')
      perf2<-performance(t.scores,'auc')
      plot(perf1,main='ROC Curve for Regression Full Model')
      abline(c(0,0),c(1,1))
      text(0.8,0.2,paste('auc=',round(unlist(perf2@y.values),3),sep=''))
      text(0.8,0.1,paste('cutoff=',round(cutoffVal,3),sep=''))
    }
    cat('\n')
    cat(paste0('#### 第',i,'个模型的逐步回归模型结果：'))
    cat('\n')
    cat(pander(summary(res$glmResStep)))
    cat('\n')
    
    cat('\n')
    cat(paste0('#### 第',i,'个模型的全模型诊断图结果：'))
    cat('\n')
    print(autoplot(res$glmResStep))
    cat('\n')
    cat('\n')
    if(myGlmParms$Family[i]=='binomial'){
      res$glmResStep->fit.tmp
      predict(fit.tmp,type='link')->pred.fit
      t.scores<-prediction(pred.fit,fit.tmp[['y']])
      cost.perf = performance(t.scores, "cost")
      t.scores@cutoffs[[1]][which.min(cost.perf@y.values[[1]])]->cutoffVal
      perf1<-performance(t.scores,'tpr','fpr')
      perf2<-performance(t.scores,'auc')
      plot(perf1,main='ROC Curve for Regression Stepwise Model')
      abline(c(0,0),c(1,1))
      text(0.8,0.2,paste('auc=',round(unlist(perf2@y.values),3),sep=''))
      text(0.8,0.1,paste('cutoff=',round(cutoffVal,3),sep=''))
    }
    cat('\n')
    cat('\n')
  }
  
}




```



# 决策树模型结果

决策树模型的结果采用R中rpart函数或ctree函数进行分析。

## 结果部分

```{r,fig.width=9,fig.height=9}
LstMadis$myTree->myTreeParms

if(is.na(myTreeParms$data)){
  cat('\n')
  cat('当前数据无模型分析结果')
  cat('\n')
} else {
  for(i in 1:nrow(myTreeParms)){
    cat('\n')
    cat(paste0('### 第',i,'个模型的结果：'))
    cat('\n')
    
    treeS(Formula=myTreeParms$Formula[i],
           data=LstMadis$Data[[myTreeParms$data[i]]],
           subset=myTreeParms$subset[i],
           treeMethod=myTreeParms$treeMethod[i],
           Minsplit=myTreeParms$Minsplit[i],
           Minbucket = myTreeParms$Minbucket[i],
           Maxdepth=myTreeParms$Maxdepth[i],
           CP=myTreeParms$CP[i],
           Mincrit = myTreeParms$Mincrit[i])->res
    
    cat('\n')
    plot(res)
    cat('\n')
    cat('\n')
  }
  
}




```




# COX模型结果

cox模型的结果采用R中coxph函数进行分析，结果提供全模型以及利用AIC进行变量筛选的逐步回归结果。

## 结果部分

```{r}
LstMadis$myCox->myCoxParms

if(is.na(myCoxParms$data)){
  cat('\n')
  cat('当前数据无模型分析结果')
  cat('\n')
} else {
  for(i in 1:nrow(myCoxParms)){
    cat('\n')
    cat(paste0('### 第',i,'个模型的结果：'))
    cat('\n')
    
    coxS(Formula=myCoxParms$Formula[i],
          data=LstMadis$Data[[myCoxParms$data[i]]],
          weightsVar=myCoxParms$weightsVar[i],
          subset=myCoxParms$subset[i],
          strataVar=myCoxParms$strataVar[i],
          lower=myCoxParms$lower[i])->res
    
    cat('\n')
    cat(paste0('#### 第',i,'个模型的全模型结果：'))
    cat('\n')
    cat(pander(res$coxResFull))
    cat('\n')
    cat(paste0('#### 第',i,'个模型的全模型图结果：'))
    cat('\n')
    print(autoplot(survfit(res$coxResFull)))
    cat('\n')
    cat(paste0('#### 第',i,'个模型的逐步回归模型结果：'))
    cat('\n')
    cat(pander(res$coxResStep))
    cat('\n')
    cat(paste0('#### 第',i,'个模型的逐步回归模型诊断图结果：'))
    cat('\n')
    print(autoplot(survfit(res$coxResStep)))
    cat('\n')
    cat('\n')
    cat(paste0('#### 第',i,'个模型的分层生存曲线：'))
    cat('\n')
    print(autoplot(res$fitStrata))
    cat('\n')
  }
  
}




```










# 混合效应模型结果

混合效应模型的结果采用R中nlme包进行分析，结果提供全模型以及利用AIC进行变量筛选的逐步回归结果。

## 结果部分

```{r}
LstMadis$myLme->myLmeParms

if(is.na(myLmeParms$data)){
  cat('\n')
  cat('当前数据无模型分析结果')
  cat('\n')
} else {
  for(i in 1:nrow(myLmeParms)){
    cat('\n')
    cat(paste0('### 第',i,'个模型的结果：'))
    cat('\n')
    
    lmeS(formulaFixed=myLmeParms$formulaFixed[i],
         formulaRandom=myLmeParms$formulaRandom[i],
          data=LstMadis$Data[[myLmeParms$data[i]]],
          Method=myLmeParms$Method[i],
          subset=myLmeParms$subset[i])->res
    
    cat('\n')
    cat(paste0('#### 第',i,'个模型的全模型结果：'))
    cat('\n')
    cat(pander(res$lmeResFull))
    cat('\n')
    cat('\n')
    cat(paste0('#### 第',i,'个模型的逐步回归模型结果：'))
    cat('\n')
    cat(pander(res$lmeResStep))
    cat('\n')
    cat('\n')
    cat('\n')
  }
  
}




```



# 聚类分析

聚类分析采用R中kmeans函数进行分析，同时，提供基于vegan包判断最佳的聚类数目。

## 结果部分

```{r}
LstMadis$Kmeans->myKmeansParms

if(is.na(myKmeansParms$data)){
  cat('\n')
  cat('当前数据无模型分析结果')
  cat('\n')
} else {
  for(i in 1:nrow(myKmeansParms)){
    cat('\n')
    cat(paste0('### 第',i,'个模型的结果：'))
    cat('\n')
    
    Kmeans(
        data=LstMadis$Data[[myKmeansParms$data[i]]],
        vars=myKmeansParms$vars[i],
        infgr=myKmeansParms$vars[i],
        supgr=myKmeansParms$vars[i],
        Centers=myKmeansParms$vars[i],
        Criterion=myKmeansParms$vars[i],
        Iter=myKmeansParms$vars[i],
        iterMax=myKmeansParms$vars[i],
        Algorithm=myKmeansParms$vars[i],
        subset=myKmeansParms$vars[i],
        clusterName=myKmeansParms$vars[i],
        seed=myKmeansParms$vars[i])->res
    
    cat('\n')
    cat(paste0('#### 第',i,'聚类分析图形结果：'))
    cat('\n')
    cat(pander(res$graphCrit))
    cat('\n')
    cat('\n')
    #cat(paste0('#### 第',i,'聚类分析结果：'))
    cat('\n')
    #cat(pander(res$resKmeans))
    cat('\n')
    cat('\n')
    cat('\n')
  }
  
}




```














# 主成分分析

主成分分析采用R psych包的principal函数进行分析。

## 结果部分

```{r}
LstMadis$pca->mypcaParms

if(is.na(mypcaParms$data)){
  cat('\n')
  cat('当前数据无模型分析结果')
  cat('\n')
} else {
  for(i in 1:nrow(mypcaParms)){
    cat('\n')
    cat(paste0('### 第',i,'个模型的结果：'))
    cat('\n')
    
    pcaS(
      data=LstMadis$Data[[mypcaParms$data[i]]],
      vars=mypcaParms$vars[i],
      nfcts=mypcaParms$nfcts[i],
      Rotate=mypcaParms$Rotate[i],
      Scores=mypcaParms$Scores[i],
      subset=mypcaParms$subset[i],
      pcaVarName=mypcaParms$pcaVarName[i])->res
    
    cat('\n')
    cat(paste0('#### 第',i,'主成分分析图形结果：'))
    cat('\n')
    plot(scree(res$dataScree))
    cat('\n')
    cat('\n')
    cat(paste0('#### 第',i,'主成分分析因子载荷结果：'))
    cat('\n')
    cat(pander(res$resPCA$loadings[]))
    cat('\n')
    cat('\n')
    cat(pander(res$cumVar))
    cat('\n')
  }
  
}




```
















# 因子分析

主成分分析采用R psych包的fa函数进行分析。

## 结果部分

```{r}
LstMadis$fa->myfaParms

if(is.na(myfaParms$data)){
  cat('\n')
  cat('当前数据无模型分析结果')
  cat('\n')
} else {
  for(i in 1:nrow(myfaParms)){
    cat('\n')
    cat(paste0('### 第',i,'个模型的结果：'))
    cat('\n')
    
    faS(
      data=LstMadis$Data[[myfaParms$data[i]]],
      vars=myfaParms$vars[i],
      nfcts=myfaParms$nfcts[i],
      Rotate=myfaParms$Rotate[i],
      Scores=myfaParms$Scores[i],
      FM=myfaParms$FM[i],
      subset=myfaParms$subset[i],
      faVarName=myfaParms$faVarName[i])->res
    
    cat('\n')
    cat(paste0('#### 第',i,'因子分析图形结果：'))
    cat('\n')
    plot(scree(res$dataScree))
    cat('\n')
    cat('\n')
    cat(paste0('#### 第',i,'因子分析因子载荷结果：'))
    cat('\n')
    cat(pander(res$resFA$loadings[]))
    cat('\n')
    cat('\n')
    cat(pander(res$cumVar))
    cat('\n')
  }
  
}




```















# 时间序列模型结果

时间序列模型采用prophet包进行分析，结果提供历史数据的按时间段分析结果以及模型预测图形。

## 结果部分

```{r}
LstMadis$myProphet->myProphetParms

if(is.na(myProphetParms$data)){
  cat('\n')
  cat('当前数据无分析结果')
  cat('\n')
} else {
  for(i in 1:nrow(myProphetParms)){
    cat('\n')
    cat(paste0('### 第',i,'个时间序列模型的结果：'))
    cat('\n')
    
    prophetS(data=LstMadis$Data[[myProphetParms$data[i]]],
              tsVar=myProphetParms$tsVar[i],
              tsFormat = myProphetParms$tsFormat[i],
              measureVars=myProphetParms$measureVars[i],
              groupVars = myProphetParms$groupVars[i],
              Period = myProphetParms$Period[i],
              FN=myProphetParms$FN[i],
              Cap=myProphetParms$Cap[i],
              Floor=myProphetParms$Floor[i],
              Growth=myProphetParms$Growth[i],
              H=myProphetParms$H[i],
              yearlyS = myProphetParms$yearlyS[i],
              dailyS = myProphetParms$dailyS[i],
              weeklyS = myProphetParms$weeklyS[i])->res
    
    cat('\n')
    cat(paste0('#### 第',i,'个时间序列历史数据结果：'))
    cat('\n')
    cat(pander(res$tabRes))
    cat('\n')
    cat(paste0('#### 第',i,'个时间序列历史数据图形结果：'))
    cat('\n')
    cat('\n')
    print(res$graphRes)
    cat('\n')
    
    cat(paste0('#### 第',i,'个时间序列预测数据结果：'))
    cat('\n')
    cat('\n')
    print(res$tabPred)
    cat('\n')
    cat('\n')
    cat(paste0('#### 第',i,'个时间序列预测图形结果：'))
    cat('\n')
    cat('\n')
    print(res$graphPredict)
    cat('\n')
    cat('\n')
  }
  
}



```




# 附表

## 分类统计表

```{r}
LstMadis$myTable->myTableParms
if(is.na(myTableParms$data)){
  cat('\n')
  cat('当前数据无模型分析结果')
  cat('\n')
} else {
  
  for(i in 1:nrow(myTableParms)){
    cat('\n')
    cat(paste0('### 第',i,'个表格的结果：'))
    cat('\n')
    cat(pander(descTab(Formula=myTableParms$Formula[i],data=LstMadis$Data[[myTableParms$data[i]]])))
    cat('\n')
    cat('\n')
    
    
    
  }
  
  
  
  
}




```


## 统计图形

```{r}
LstMadis$myGplt->myGpltParms
if(is.na(myGpltParms$data)){
  cat('\n')
  cat('当前数据无图形结果')
  cat('\n')
} else {
  
  for(i in 1:nrow(myGpltParms)){
    cat('\n')
    cat(paste0('### 第',i,'个图形的结果：'))
    cat('\n')
    print(ggplt2S(
      data=LstMadis$Data[[myGpltParms$data[i]]],
      x=myGpltParms$x[i],
      y=myGpltParms$y[i],
      size=myGpltParms$size[i],
      fill=myGpltParms$fill[i],
      color=myGpltParms$color[i],
      shape=myGpltParms$shape[i],
      alpha=myGpltParms$alpha[i],
      facetVar=myGpltParms$facetVar[i],
      geom=myGpltParms$geom[i],
      smoothMethod=myGpltParms$smoothMethod[i],
      barPos=myGpltParms$barPos[i],
      labx=myGpltParms$labx[i],
      laby=myGpltParms$laby[i],
      title=myGpltParms$title[i],
      Bins=myGpltParms$Bins[i],
      theme=myGpltParms$theme[i],
      Width=myGpltParms$Width[i],
      Colour=myGpltParms$Colour[i],
      Fill=myGpltParms$Fill[i],
      Size=myGpltParms$Size[i],
      Alpha=myGpltParms$Alpha[i],
      Shape=myGpltParms$Shape[i]
    )$resGGplot)
    cat('\n')
    cat('\n')
    
    
    
  }
  
  
  
  
}




```
